"""Add StopArea, StopPoint, Poi, Admin, Route, Line, Network tables

and a view to rule them all

Revision ID: 2dbd03089f34
Revises: 423e8da9d857
Create Date: 2014-01-30 12:39:11.839925

"""

# revision identifiers, used by Alembic.
revision = '2dbd03089f34'
down_revision = '423e8da9d857'

from alembic import op
import sqlalchemy as sa
import geoalchemy2 as ga


def upgrade():
    ### commands auto generated by Alembic - please adjust! ###
    op.create_table('stop_point',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('coord', ga.Geography(geometry_type='POINT', srid=4326, spatial_index=False), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_stop_point_original_uri', 'stop_point', ['original_uri'], unique=False)
    op.create_table('line',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_line_original_uri', 'line', ['original_uri'], unique=False)
    op.create_table('poi',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('coord', ga.Geography(geometry_type='POINT', srid=4326, spatial_index=False), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_poi_original_uri', 'poi', ['original_uri'], unique=False)
    op.create_table('route',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_route_original_uri', 'route', ['original_uri'], unique=False)
    op.create_table('admin',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_admin_original_uri', 'admin', ['original_uri'], unique=False)
    op.create_table('network',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_network_original_uri', 'network', ['original_uri'], unique=False)
    op.create_table('stop_area',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('uri', sa.Text(), nullable=False),
    sa.Column('coord', ga.Geography(geometry_type='POINT', srid=4326, spatial_index=False), nullable=True),
    sa.Column('name', sa.Text(), nullable=False),
    sa.Column('original_uri', sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('uri')
    )
    op.create_index('ix_stop_area_original_uri', 'stop_area', ['original_uri'], unique=False)
    op.create_table('rel_stop_area_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['stop_area.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_poi_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['poi.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_network_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['network.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_line_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['line.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_admin_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['object_id'], ['admin.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_stop_point_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['stop_point.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )
    op.create_table('rel_route_instance',
    sa.Column('object_id', sa.Integer(), nullable=False),
    sa.Column('instance_id', sa.Integer(), nullable=False),
    sa.ForeignKeyConstraint(['instance_id'], ['instance.id'], ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['object_id'], ['route.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('object_id', 'instance_id')
    )

    op.execute("""
        CREATE VIEW ptobject AS
            SELECT id, uri, original_uri, name, 'stop_area' as type FROM stop_area UNION
            SELECT id, uri, original_uri, name, 'stop_point' as type FROM stop_point UNION
            SELECT id, uri, original_uri, name, 'poi' as type FROM poi UNION
            SELECT id, uri, original_uri, name, 'admin' as type FROM admin UNION
            SELECT id, uri, original_uri, name, 'line' as type FROM line UNION
            SELECT id, uri, original_uri, name, 'route' as type FROM route UNION
            SELECT id, uri, original_uri, name, 'network' as type FROM network
                      ;""")
    ### end Alembic commands ###


def downgrade():
    ### commands auto generated by Alembic - please adjust! ###
    op.execute("DROP VIEW ptobject CASCADE;")
    op.drop_table('rel_route_instance')
    op.drop_table('rel_stop_point_instance')
    op.drop_table('rel_admin_instance')
    op.drop_table('rel_line_instance')
    op.drop_table('rel_network_instance')
    op.drop_table('rel_poi_instance')
    op.drop_table('rel_stop_area_instance')
    op.drop_index('ix_stop_area_original_uri', 'stop_area')
    op.drop_table('stop_area')
    op.drop_index('ix_network_original_uri', 'network')
    op.drop_table('network')
    op.drop_index('ix_admin_original_uri', 'admin')
    op.drop_table('admin')
    op.drop_index('ix_route_original_uri', 'route')
    op.drop_table('route')
    op.drop_index('ix_poi_original_uri', 'poi')
    op.drop_table('poi')
    op.drop_index('ix_line_original_uri', 'line')
    op.drop_table('line')
    op.drop_index('ix_stop_point_original_uri', 'stop_point')
    op.drop_table('stop_point')
    ### end Alembic commands ###
